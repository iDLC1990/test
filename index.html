<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LCDR LIVE DATA 2025 - Диагонали</title>
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: Arial, sans-serif;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 10%;
      background-color: #111;
      flex-wrap: wrap;
    }
    .header h1 {
      margin: 0;
      color: #008080;
      font-size: 24px;
    }
    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    .date-info {
      color: #008080;
      font-size: 20px;
    }
    select, button {
      padding: 6px 10px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
      border: none;
    }
    button {
      background-color: #008080;
      color: #000;
      font-weight: bold;
    }
    #stats-container {
      width: 90%;
      margin: 24px auto;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #222;
      color: #fff;
    }
    th, td {
      border: 1px solid #555;
      padding: 8px 10px;
      text-align: center;
      font-size: 14px;
      white-space: nowrap;
    }
    th {
      background-color: #008080;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    td:first-child {
      background-color: #111;
      font-weight: bold;
      text-align: left;
      position: sticky;
      left: 0;
      z-index: 1;
    }
    th.total-col, td.total-col {
      background-color: #005050;
      font-weight: bold;
    }
    tfoot td {
      background-color: #005050;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>LCDR LIVE DATA 2025 - Диагонали</h1>
    <div class="controls">
      <label for="month-select" class="date-info">Wybierz miesiąc:</label>
      <select id="month-select"></select>
      <button id="toggle-percent">Показать %</button>
    </div>
  </div>

  <div id="stats-container">
    <!-- Таблица появится здесь -->
  </div>

<script>
  const apiKey = 'AIzaSyCP7tzYiGwIZ6cymLAlv_9QgPIEshnRgqI';
  const sheetId = '10W03bvKlVFlIUcxsHkzP_v_13gtnYRBmnrrO0ujB1bU';
  const sheetURL = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/`;

  // Сопоставление кода к диагонали
  const diagonalMap = {
    '860': 86,
    '850': 85,
    '750': 75,
    '700': 70,
    '650': 65,
    '580': 58,
    '575': 58,
    '550': 55,
    '545': 55,
    '500': 50,
    '498': 50,
    '495': 50,
    '490': 50,
    '438': 43,
    '435': 43,
    '430': 43,
    '428': 43,
    '425': 43,
    '420': 43,
    '418': 43,
    '415': 43,
    '398': 43,
    '395': 43,
    '390': 43,
    '348': 32,
    '345': 32,
    '340': 32,
    '328': 32,
    '325': 32,
    '320': 32,
    '318': 32,
    '315': 32,
    '278': 27,
    '275': 27,
    '270': 27,
    '248': 24,
    '245': 24,
    '240': 24,
    '238': 24,
    '235': 24,
    '230': 24
  };

  // Список допустимых префиксов (первая часть серийника)
  // Могут быть любые буквы, поэтому не ограничиваем, просто проверяем 3 буквы в начале
  function getDiagonal(serial) {
    if (!serial || serial.length < 6) return null; // минимум 3 буквы + 3 цифры

    // Проверим первые 3 символа — должны быть буквы
    const prefix = serial.slice(0, 3);
    if (!/^[A-Z]{3}$/i.test(prefix)) return null;

    // После первых 3 букв идут 3 цифры — это код диагонали
    const code = serial.slice(3, 6);
    if (!/^\d{3}$/.test(code)) return null;

    if (diagonalMap.hasOwnProperty(code)) {
      return diagonalMap[code];
    }
    return null;
  }

  async function getData(sheetName) {
    try {
      const response = await fetch(`${sheetURL}${encodeURIComponent(sheetName)}?key=${apiKey}`);
      const data = await response.json();
      return data.values || [];
    } catch (err) {
      console.error('Ошибка получения данных:', err);
      return [];
    }
  }

  async function fetchData() {
    const sheetNames = ['FI Station KOVALCHYK Y.', 'FI Station 2 ULANOVYCH.R'];
    let combined = [];

    for (const name of sheetNames) {
      const sheetData = await getData(name);
      if (sheetData.length < 2) continue;
      const rows = sheetData.slice(1);
      const mapped = rows.map(row => ({
        date: row[0] || '',
        serial: row[2] || '',
        status: row[4] || '',
        person: row[5] || ''
      }));
      combined = combined.concat(mapped);
    }
    return combined;
  }

  function calculateDetailedStats(data) {
    const stats = {};

    data.forEach(({ date, serial, status, person }) => {
      const diagonal = getDiagonal(serial);
      if (!diagonal) return;

      if (!stats[person]) stats[person] = {};
      if (!stats[person][diagonal]) stats[person][diagonal] = { OK: 0, NDF: 0, days: new Set() };

      if (status === 'OK') stats[person][diagonal].OK++;
      if (status === 'NDF') stats[person][diagonal].NDF++;

      const day = date.split(' ')[0];
      if (day) stats[person][diagonal].days.add(day);
    });

    return stats;
  }

  function renderTable(stats, showPercent = false) {
    const container = document.getElementById('stats-container');
    container.innerHTML = '';

    const people = Object.keys(stats).sort();
    if (people.length === 0) {
      container.innerHTML = '<p style="text-align:center; margin-top:20px;">Нет данных для выбранного месяца</p>';
      return;
    }

    const table = document.createElement('table');

    // Заголовок
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');

    const thName = document.createElement('th');
    thName.textContent = 'Name';
    headerRow.appendChild(thName);

    diagonalsHeaders = Object.values(diagonalMap).filter((v, i, a) => a.indexOf(v) === i).sort((a,b) => b - a);

    // Используем отсортированный массив диагоналей из diagonalMap
    diagonalsHeaders.forEach(d => {
      const th = document.createElement('th');
      th.textContent = d;
      headerRow.appendChild(th);
    });

    // Новые столбцы: Day и % per month
    const thDay = document.createElement('th');
    thDay.textContent = 'Day';
    headerRow.appendChild(thDay);

    const thPercentPerMonth = document.createElement('th');
    thPercentPerMonth.textContent = '% per month';
    headerRow.appendChild(thPercentPerMonth);

    // Итоговый столбец Total
    const thTotalCol = document.createElement('th');
    thTotalCol.textContent = 'Total';
    thTotalCol.classList.add('total-col');
    headerRow.appendChild(thTotalCol);

    thead.appendChild(headerRow);
    table.appendChild(thead);

    // Подсчёт общей суммы по диагоналям
    const totalPerDiagonal = {};
    diagonalsHeaders.forEach(d => totalPerDiagonal[d] = 0);

    // Создаем тело таблицы
    const tbody = document.createElement('tbody');

    people.forEach(person => {
      const tr = document.createElement('tr');
      const tdName = document.createElement('td');
      tdName.textContent = person;
      tr.appendChild(tdName);

      let totalPersonSum = 0;
      let totalDaysSet = new Set();

      diagonalsHeaders.forEach(d => {
        const td = document.createElement('td');
        if (stats[person][d]) {
          const s = stats[person][d];
          const sumOKNDF = s.OK + s.NDF;
          totalPersonSum += sumOKNDF;
          totalPerDiagonal[d] += sumOKNDF;
          s.days.forEach(day => totalDaysSet.add(day));

          if (showPercent) {
            const percent = totalPerDiagonal[d] ? ((sumOKNDF / totalPerDiagonal[d]) * 100).toFixed(1) : '0.0';
            td.textContent = percent + '%';
          } else {
            td.textContent = sumOKNDF;
          }
        } else {
          td.textContent = '-';
        }
        tr.appendChild(td);
      });

      // Столбец Day — количество уникальных дней
      const tdDay = document.createElement('td');
      tdDay.textContent = totalDaysSet.size;
      tr.appendChild(tdDay);

      // Столбец % per month — отношение итога этого человека к общей сумме всех
      const tdPercentPerMonth = document.createElement('td');
      const totalAll = Object.values(stats).reduce((acc, personStats) => {
        return acc + Object.values(personStats).reduce((acc2, diagStats) => acc2 + diagStats.OK + diagStats.NDF, 0);
      }, 0);
      tdPercentPerMonth.textContent = totalAll ? ((totalPersonSum / totalAll) * 100).toFixed(1) + '%' : '0.0%';
      tr.appendChild(tdPercentPerMonth);

      // Итог (Total)
      const tdTotal = document.createElement('td');
      tdTotal.textContent = showPercent ? '' : totalPersonSum;
      tdTotal.classList.add('total-col');
      tdTotal.setAttribute('title', 'Total');
      tr.appendChild(tdTotal);

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);

    // Нижняя строка с суммами — Total Repaired
    const tfoot = document.createElement('tfoot');
    const footerRow = document.createElement('tr');

    const footerNameCell = document.createElement('td');
    footerNameCell.textContent = 'Total Repaired';
    footerNameCell.style.textAlign = 'left';
    footerRow.appendChild(footerNameCell);

    diagonalsHeaders.forEach(d => {
      const td = document.createElement('td');
      td.classList.add('total-col');
      if (showPercent) {
        td.textContent = '100%';
      } else {
        td.textContent = totalPerDiagonal[d];
      }
      footerRow.appendChild(td);
    });

    // Пустые ячейки для Day и % per month
    const tdEmptyDay = document.createElement('td');
    tdEmptyDay.classList.add('total-col');
    footerRow.appendChild(tdEmptyDay);

    const tdEmptyPercent = document.createElement('td');
    tdEmptyPercent.classList.add('total-col');
    footerRow.appendChild(tdEmptyPercent);

    // Общая сумма всех диагоналей в последней ячейке
    const tdGrandTotal = document.createElement('td');
    tdGrandTotal.classList.add('total-col');
    if (showPercent) {
      tdGrandTotal.textContent = '';
    } else {
      const grandTotal = Object.values(totalPerDiagonal).reduce((a, b) => a + b, 0);
      tdGrandTotal.textContent = grandTotal;
    }
    footerRow.appendChild(tdGrandTotal);

    tfoot.appendChild(footerRow);
    table.appendChild(tfoot);

    container.appendChild(table);
  }

  function updateMonthOptions(data) {
    const select = document.getElementById('month-select');
    const months = new Set();

    data.forEach(row => {
      if (row.date) {
        const date = new Date(row.date);
        if (!isNaN(date)) {
          const key = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
          months.add(key);
        }
      }
    });

    const sortedMonths = Array.from(months).sort().reverse();
    select.innerHTML = '';
    sortedMonths.forEach(month => {
      const option = document.createElement('option');
      option.value = month;
      option.textContent = month;
      select.appendChild(option);
    });
  }

  (async function initialize() {
    const allData = await fetchData();
    updateMonthOptions(allData);

    let showPercent = false;

    function updateTableForMonth(month) {
      const filteredData = allData.filter(row => {
        if (row.date) {
          const date = new Date(row.date);
          const key = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
          return key === month;
        }
        return false;
      });
      const stats = calculateDetailedStats(filteredData);
      renderTable(stats, showPercent);
    }

    const select = document.getElementById('month-select');
    select.addEventListener('change', () => {
      updateTableForMonth(select.value);
    });

    const toggleBtn = document.getElementById('toggle-percent');
    toggleBtn.addEventListener('click', () => {
      showPercent = !showPercent;
      toggleBtn.textContent = showPercent ? 'Показать количество' : 'Показать %';
      updateTableForMonth(select.value);
    });

    if (select.value) {
      updateTableForMonth(select.value);
    } else if (select.options.length > 0) {
      select.selectedIndex = 0;
      updateTableForMonth(select.options[0].value);
    }
  })();
</script>
</body>
</html>