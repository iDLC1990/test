    function calculateDetailedStats(data) {
      const stats = {};
      data.forEach(({ date, serial, status, person }) => {
        if (!validStatuses.includes(status)) return; // учитываем только OK и NDF
        const diagonal = getDiagonal(serial);
        if (!diagonal) return;

        if (!stats[person]) stats[person] = {};
        if (!stats[person][diagonal]) stats[person][diagonal] = { sum: 0, days: new Set() };

        stats[person][diagonal].sum++;
        const day = date.split(' ')[0];
        if (day) stats[person][diagonal].days.add(day);
      });
      return stats;
    }

    function renderTable(stats) {
      const container = document.getElementById('stats-container');
      container.innerHTML = '';

      const diagonals = Array.from(new Set(
        Object.values(stats).flatMap(p => Object.keys(p).map(Number))
      )).sort((a, b) => b - a);

      const people = Object.keys(stats).sort();
      if (people.length === 0) {
        container.innerHTML = '<p style="text-align:center; margin-top:20px;">Нет данных для выбранного месяца</p>';
        return;
      }

      let percentPerMonthMode = false;
      let totalModePercent = false;

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');

      const thName = document.createElement('th');
      thName.textContent = 'Name';
      headerRow.appendChild(thName);

      diagonals.forEach(d => {
        const th = document.createElement('th');
        th.textContent = d;
        headerRow.appendChild(th);
      });

      // Колонка Days (кол-во дней с работой)
      const thDays = document.createElement('th');
      thDays.textContent = 'Day';
      headerRow.appendChild(thDays);

      // Кнопка % per month с двумя режимами
      const thPercentPerMonth = document.createElement('th');
      thPercentPerMonth.textContent = '% per month';
      thPercentPerMonth.style.cursor = 'pointer';
      thPercentPerMonth.title = 'Клик для переключения режима: среднее или процент диагоналей';
      headerRow.appendChild(thPercentPerMonth);

      // Кнопка Total, переключающая отображение total (число или % от общего)
      const thTotal = document.createElement('th');
      thTotal.textContent = 'Total';
      thTotal.className = 'total-col';
      thTotal.style.cursor = 'pointer';
      thTotal.title = 'Клик для переключения Total: число / % от общей суммы';
      headerRow.appendChild(thTotal);

      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');

      let globalTotal = 0;
      const totalPerDiagonal = {};
      diagonals.forEach(d => totalPerDiagonal[d] = 0);

      const personTotals = {};

      // Предварительный подсчет глобального total и totalPerDiagonal
      people.forEach(person => {
        let total = 0;
        diagonals.forEach(d => {
          if (stats[person][d]) {
            total += stats[person][d].sum;
            totalPerDiagonal[d] += stats[person][d].sum;
          }
        });
        globalTotal += total;
        personTotals[person] = total;
      });

      people.forEach(person => {
        const tr = document.createElement('tr');

        // Имя
        const tdName = document.createElement('td');
        tdName.textContent = person;
        tr.appendChild(tdName);

        // Колонки диагоналей
        diagonals.forEach(d => {
          const td = document.createElement('td');
          if (stats[person][d]) {
            td.textContent = stats[person][d].sum;
          } else {
            td.textContent = '-';
          }
          tr.appendChild(td);
        });

        // Колонка Days - считаем уникальные дни по всем диагоналям
        const daysSet = new Set();
        diagonals.forEach(d => {
          if (stats[person][d]) {
            stats[person][d].days.forEach(day => daysSet.add(day));
          }
        });
        const tdDays = document.createElement('td');
        tdDays.textContent = daysSet.size;
        tr.appendChild(tdDays);

        // Колонка % per month (по умолчанию режим 1 — среднее арифметическое)
        const tdPercentPerMonth = document.createElement('td');
        const totalForPerson = personTotals[person];
        let percentValue;
        if (daysSet.size > 0) {
          // режим 1: среднее число диагоналей в день (число)
          percentValue = (totalForPerson / daysSet.size).toFixed(1);
          tdPercentPerMonth.textContent = percentValue;
        } else {
          tdPercentPerMonth.textContent = '0';
        }
        tr.appendChild(tdPercentPerMonth);

        // Колонка Total (по умолчанию показываем число)
        const tdTotal = document.createElement('td');
        tdTotal.textContent = totalForPerson;
        tdTotal.classList.add('total-col');
        tr.appendChild(tdTotal);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);

      // Футер с суммами по диагоналям и общим Total
      const tfoot = document.createElement('tfoot');
      const footerRow = document.createElement('tr');

      const tdLabel = document.createElement('td');
      tdLabel.textContent = 'Total Repaired';
      footerRow.appendChild(tdLabel);

      diagonals.forEach(d => {
        const td = document.createElement('td');
        td.textContent = totalPerDiagonal[d];
        td.classList.add('total-col');
        footerRow.appendChild(td);
      });

      // Пустые ячейки для Day и % per month
      footerRow.appendChild(document.createElement('td'));
      footerRow.appendChild(document.createElement('td'));

      const tdTotalAll = document.createElement('td');
      tdTotalAll.textContent = globalTotal;
      tdTotalAll.classList.add('total-col');
      footerRow.appendChild(tdTotalAll);

      tfoot.appendChild(footerRow);
      table.appendChild(tfoot);

      container.appendChild(table);

      // Обработчики кнопок

      // Кнопка % per month (переключает режим отображения)
      thPercentPerMonth.addEventListener('click', () => {
        percentPerMonthMode = !percentPerMonthMode;
        tbody.querySelectorAll('tr').forEach(tr => {
          const personName = tr.firstChild.textContent;
          const statsPerson = stats[personName];
          if (!statsPerson) return;
          const totalForPerson = personTotals[personName];

          // Колонка Days
          const daysCell = tr.children[diagonals.length + 1];
          const daysCount = Number(daysCell.textContent);

          const percentCell = tr.children[diagonals.length + 2]; // td % per month

          if (!percentPerMonthMode) {
            // режим 1 — среднее арифметическое (число)
            if (daysCount > 0) {
              percentCell.textContent = (totalForPerson / daysCount).toFixed(1);
            } else {
              percentCell.textContent = '0';
            }
          } else {
            // режим 2 — % для каждой диагонали от total, надо показать сумму процентов (100%)
            // но т.к. в одной ячейке — отобразим 100%
            percentCell.textContent = '100%';
          }
        });
      });

      // Кнопка Total (переключает число / % от глобального total)
      thTotal.addEventListener('click', () => {
        totalModePercent = !totalModePercent;
        tbody.querySelectorAll('tr').forEach(tr => {
          const personName = tr.firstChild.textContent;
          const totalForPerson = personTotals[personName];
          const totalCell = tr.lastChild;

          if (totalModePercent) {
            totalCell.textContent = globalTotal ? ((totalForPerson / globalTotal) * 100).toFixed(1) + '%' : '0%';
          } else {
            totalCell.textContent = totalForPerson;
          }
        });
      });
    }

    function populateMonthSelect() {
      const select = document.getElementById('month-select');
      const now = new Date();

      for (let i = 0; i < 12; i++) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        const label = date.toLocaleDateString('pl-PL', { month: 'long', year: 'numeric' });
        const option = document.createElement('option');
        option.value = value;
        option.textContent = label.charAt(0).toUpperCase() + label.slice(1);
        select.appendChild(option);
      }
      select.selectedIndex = 0;
    }

    function filterDataByMonth(data, monthStr) {
      return data.filter(item => {
        if (!item.date) return false;
        const [year, month] = monthStr.split('-').map(Number);
        const itemDate = new Date(item.date);
        return itemDate.getFullYear() === year && (itemDate.getMonth() + 1) === month;
      });
    }

    async function init() {
      populateMonthSelect();
      let allData = await fetchData();

      const select = document.getElementById('month-select');
      function updateTable() {
        const filtered = filterDataByMonth(allData, select.value);
        const stats = calculateDetailedStats(filtered);
        renderTable(stats);
      }
      select.addEventListener('change', updateTable);
      updateTable();
    }

    init();
  </script>
</body>
</html>
