<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LCDR LIVE DATA 2025</title>
  <style>
    body { background-color: #000; color: #fff; font-family: Arial, sans-serif; }
    .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 10%; background-color: #111; flex-wrap: wrap; }
    .header h1 { margin: 0; color: #005050; font-size: 24px; }
    .controls { display: flex; align-items: center; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .date-info { color: #005050; font-size: 18px; }
    select, input[type=date] { padding: 6px 10px; font-size: 16px; border-radius: 5px; border: none; }
    #stats-container, #scrap-waiting-container { width: 90%; margin: 24px auto; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; background-color: #222; color: #fff; }
    th, td { border: 1px solid #555; padding: 8px 10px; text-align: center; font-size: 14px; white-space: nowrap; }
    th { background-color: #005050; font-weight: bold; position: sticky; top: 0; z-index: 1; cursor: pointer; }
    td:first-child { background-color: #111; font-weight: bold; text-align: left; position: sticky; left: 0; z-index: 1; }
    th.total-col, td.total-col { background-color: #005050; font-weight: bold; }
    tfoot td { background-color: #005050; font-weight: bold; }
    .cell-split { display: flex; justify-content: space-between; }
    .scrap { color: #ff5555; }
    .waiting { color: #55ff55; }
    details summary { cursor: pointer; font-size: 18px; color: #005050; margin-bottom: 10px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>LCDR LIVE DATA 2025</h1>
    <div class="controls">
      <label class="date-info">Tryb:</label>
      <select id="filter-type">
        <option value="day" selected>Dzień</option>
        <option value="month">Miesiąc</option>
        <option value="year">Rok</option>
      </select>

      <!-- Контейнер для календарей -->
      <div id="day-picker-container" style="display:flex; align-items:center; gap:10px;">
        <label class="date-info">Od:</label>
        <input type="date" id="date-from" />
        <label class="date-info">Do:</label>
        <input type="date" id="date-to" />
      </div>

      <!-- Контейнер для месяца/года -->
      <div id="month-year-container" style="display:none; align-items:center; gap:10px;">
        <label class="date-info">Wybierz:</label>
        <select id="month-year-select"></select>
      </div>
    </div>
  </div>

  <div id="stats-container"></div>

  <details id="scrap-waiting-table">
    <summary>Scrap / Waiting Stats</summary>
    <div id="scrap-waiting-container"></div>
  </details>

  <script>
    const apiKey = 'AIzaSyCP7tzYiGwIZ6cymLAlv_9QgPIEshnRgqI';
    const sheetId = '10W03bvKlVFlIUcxsHkzP_v_13gtnYRBmnrrO0ujB1bU';
    const sheetURL = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/`;
    const validStatuses = ['OK', 'NDF'];

    const diagonalMapPrefix = { 'WH8':55,'WC8':32,'WU0':43,'SQ1':43,'WM5':50,'WC7':32,'WP5':65,'WW1':75,'WM6':50 };
    const diagonalMap = {
      '860':86,'850':85,'750':75,'700':70,'650':65,'580':58,'575':58,
      '550':55,'545':55,'500':50,'498':50,'495':50,'490':50,
      '438':43,'435':43,'430':43,'428':43,'425':43,'420':43,
      '418':43,'415':43,'398':43,'395':43,'390':43,
      '348':32,'345':32,'340':32,'328':32,'325':32,'320':32,
      '318':32,'315':32,'278':27,'275':27,'270':27,
      '248':24,'245':24,'240':24,'238':24,'235':24,'230':24
    };

    function getDiagonals(serial){
      if(!serial || serial.length<6) return [];
      const upper = serial.toUpperCase();
      const result = new Set();
      const match = upper.match(/^[A-Z]{3}(\d{3})/);
      if(match && diagonalMap[match[1]]) result.add(diagonalMap[match[1]]);
      const prefix = upper.slice(0,3);
      if(diagonalMapPrefix[prefix]) result.add(diagonalMapPrefix[prefix]);
      return [...result];
    }

    async function getData(sheetName){
      try{
        const response = await fetch(`${sheetURL}${encodeURIComponent(sheetName)}?key=${apiKey}`);
        const data = await response.json();
        return data.values || [];
      }catch(err){
        console.error('Ошибка получения данных:', err);
        return [];
      }
    }

    async function fetchData(){
      const sheetNames = ['FI Station KOVALCHYK Y.','FI Station 2 ULANOVYCH.R'];
      let combined = [];
      for(const name of sheetNames){
        const sheetData = await getData(name);
        if(sheetData.length<2) continue;
        const rows = sheetData.slice(1);
        const mapped = rows.map(row=>({
          date: row[0]||'',
          serial: row[2]||'',
          status: (row[4]||'').toUpperCase(),
          person: row[5]||''
        }));
        combined = combined.concat(mapped);
      }
      return combined;
    }

    function calculateDetailedStats(data){
      const stats = {};
      data.forEach(({date, serial, status, person})=>{
        if(!validStatuses.includes(status)) return;
        const diagonals = getDiagonals(serial);
        if(diagonals.length===0) return;
        if(!stats[person]) stats[person]={};
        diagonals.forEach(diagonal=>{
          if(!stats[person][diagonal]) stats[person][diagonal]={ sum:0, days:new Set() };
          stats[person][diagonal].sum++;
          const day = date.split(' ')[0];
          if(day) stats[person][diagonal].days.add(day);
        });
      });
      return stats;
    }

    function calculateScrapWaitingStats(data){
      const stats = {};
      data.forEach(({serial, status, person})=>{
        if(!person||!serial||!status) return;
        const upperStatus = status.toUpperCase();
        let type = null;
        if(upperStatus.includes('SCRAP')) type='scrap';
        else if(upperStatus.includes('WAITING')) type='waiting';
        else return;
        const diagonals = getDiagonals(serial);
        if(diagonals.length===0) return;
        if(!stats[person]) stats[person]={};
        diagonals.forEach(diagonal=>{
          if(!stats[person][diagonal]) stats[person][diagonal]={scrap:0, waiting:0};
          stats[person][diagonal][type]++;
        });
      });
      return stats;
    }

    function fillMonthYearSelect(type){
      const select = document.getElementById('month-year-select'); select.innerHTML='';
      const now = new Date();
      if(type==='month'){
        for(let i=0;i<12;i++){
          const d = new Date(now.getFullYear(), now.getMonth()-i,1);
          const y=d.getFullYear(); const m=(d.getMonth()+1).toString().padStart(2,'0');
          const val = `${y}-${m}`;
          const opt=document.createElement('option'); opt.value=val; opt.textContent=val; select.appendChild(opt);
        }
      }else if(type==='year'){
        for(let i=0;i<5;i++){
          const y=now.getFullYear()-i;
          const opt=document.createElement('option'); opt.value=y.toString(); opt.textContent=y.toString(); select.appendChild(opt);
        }
      }
      return select.value;
    }

    async function update(){
      const filterType = document.getElementById('filter-type').value;
      const allData = await fetchData();
      let filtered = [];

      if(filterType==='day'){
        const dateFrom = document.getElementById('date-from').value;
        const dateTo = document.getElementById('date-to').value;
        filtered = allData.filter(d => {
          if(!d.date) return false;
          const date = d.date.split(' ')[0];
          if(dateFrom && date < dateFrom) return false;
          if(dateTo && date > dateTo) return false;
          return true;
        });
      } else {
        const selected = document.getElementById('month-year-select').value;
        filtered = allData.filter(d => d.date.startsWith(selected));
      }

      const stats = calculateDetailedStats(filtered);
      renderTable(stats);

      const scrapWaitingStats = calculateScrapWaitingStats(filtered);
      renderScrapWaitingTable(scrapWaitingStats);
    }

    function toggleControls(){
      const filterType = document.getElementById('filter-type').value;
      const dayPicker = document.getElementById('day-picker-container');
      const monthYear = document.getElementById('month-year-container');
      if(filterType==='day'){
        dayPicker.style.display='flex';
        monthYear.style.display='none';
      }else{
        dayPicker.style.display='none';
        monthYear.style.display='flex';
        fillMonthYearSelect(filterType);
      }
    }

    // Инициализация календарей
    (function initDatePickers() {
      const now = new Date();
      const today = now.toISOString().split('T')[0];
      document.getElementById('date-to').value = today;
      const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
      document.getElementById('date-from').value = firstDay;

      document.getElementById('date-from').addEventListener('change', update);
      document.getElementById('date-to').addEventListener('change', update);
    })();

    document.getElementById('filter-type').addEventListener('change', async()=>{
      toggleControls();
      await update();
    });
    document.getElementById('month-year-select').addEventListener('change', update);

    (async()=>{
      toggleControls();
      await update();
      setInterval(update, 300000);
    })();

    // --- renderTable и renderScrapWaitingTable оставляем как в предыдущем коде ---
    // Скопируй сюда функции renderTable(stats) и renderScrapWaitingTable(stats) из предыдущего полного кода.
  </script>
</body>
</html>