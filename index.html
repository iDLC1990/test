<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LCDR LIVE DATA 2025 - Диагонали</title>
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: Arial, sans-serif;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 10%;
      background-color: #111;
      flex-wrap: wrap;
    }
    .header h1 {
      margin: 0;
      color: #008080;
      font-size: 24px;
    }
    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    .date-info {
      color: #008080;
      font-size: 20px;
    }
    select, button {
      padding: 6px 10px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
      border: none;
    }
    button {
      background-color: #008080;
      color: #000;
      font-weight: bold;
    }
    #stats-container {
      width: 90%;
      margin: 24px auto;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #222;
      color: #fff;
    }
    th, td {
      border: 1px solid #555;
      padding: 8px 10px;
      text-align: center;
      font-size: 14px;
      white-space: nowrap;
    }
    th {
      background-color: #008080;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    td:first-child {
      background-color: #111;
      font-weight: bold;
      text-align: left;
      position: sticky;
      left: 0;
      z-index: 1;
    }
    th.total-col, td.total-col {
      background-color: #005050;
      font-weight: bold;
    }
    tfoot td {
      background-color: #005050;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>LCDR LIVE DATA 2025 - Диагонали</h1>
    <div class="controls">
      <label for="month-select" class="date-info">Wybierz miesiąc:</label>
      <select id="month-select"></select>
      <button id="toggle-percent">Показать %</button>
    </div>
  </div>

  <div id="stats-container"></div>

<script>
const apiKey = 'AIzaSyCP7tzYiGwIZ6cymLAlv_9QgPIEshnRgqI';
const sheetId = '10W03bvKlVFlIUcxsHkzP_v_13gtnYRBmnrrO0ujB1bU';
const sheetURL = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/`;

const diagonals = [86, 85, 75, 70, 65, 58, 55, 50, 43, 32, 27, 24];

function getDiagonal(serial) {
  if (!serial) return null;
  serial = serial.toUpperCase();
  const prefix = serial.slice(0, 3);
  const digits = serial.slice(3, 6);

  if (!/^[A-Z]{3}$/.test(prefix)) return null;
  if (!/^\d{3}$/.test(digits)) return null;

  const map = {
    '860': 86, '850': 85, '750': 75, '700': 70, '650': 65, '580': 58, '575': 58,
    '550': 55, '545': 55, '500': 50, '498': 50, '495': 50, '490': 50,
    '438': 43, '435': 43, '430': 43, '428': 43, '425': 43, '420': 43,
    '418': 43, '415': 43, '398': 43, '395': 43, '390': 43,
    '348': 32, '345': 32, '340': 32, '328': 32, '325': 32, '320': 32,
    '318': 32, '315': 32,
    '278': 27, '275': 27, '270': 27,
    '248': 24, '245': 24, '240': 24, '238': 24, '235': 24, '230': 24
  };
  return map[digits] || null;
}

async function getData(sheetName) {
  try {
    const response = await fetch(`${sheetURL}${encodeURIComponent(sheetName)}?key=${apiKey}`);
    const data = await response.json();
    return data.values || [];
  } catch (err) {
    console.error('Ошибка получения данных:', err);
    return [];
  }
}

async function fetchData() {
  const sheetNames = ['FI Station KOVALCHYK Y.', 'FI Station 2 ULANOVYCH.R'];
  let combined = [];

  for (const name of sheetNames) {
    const sheetData = await getData(name);
    if (sheetData.length < 2) continue;
    const rows = sheetData.slice(1);
    const mapped = rows.map(row => ({
      date: row[0] || '',
      serial: row[2] || '',
      status: row[4] || '',
      person: row[5] || ''
    }));
    combined = combined.concat(mapped);
  }
  return combined;
}

function calculateDetailedStats(data) {
  const stats = {};

  data.forEach(({ date, serial, status, person }) => {
    const diagonal = getDiagonal(serial);
    if (!diagonal) return;

    if (!stats[person]) stats[person] = {};
    if (!stats[person][diagonal]) stats[person][diagonal] = { count: 0, days: new Set() };

    stats[person][diagonal].count++;

    const day = date.split(' ')[0];
    if (day) stats[person][diagonal].days.add(day);
  });

  return stats;
}

function renderTable(stats, showPercent = false) {
  const container = document.getElementById('stats-container');
  container.innerHTML = '';

  const people = Object.keys(stats).sort();
  if (people.length === 0) {
    container.innerHTML = '<p style="text-align:center; margin-top:20px;">Нет данных для выбранного месяца</p>';
    return;
  }

  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const headerRow = document.createElement('tr');

  headerRow.innerHTML = '<th></th>' + diagonals.map(d => `<th>${d}</th>`).join('') + '<th class="total-col">Итого</th><th>Дней</th><th>% в мес</th>';
  thead.appendChild(headerRow);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  const totalPerDiagonal = {};
  diagonals.forEach(d => totalPerDiagonal[d] = 0);
  let grandTotal = 0;

  people.forEach(person => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${person}</td>`;

    let personTotal = 0;
    let personDays = new Set();

    diagonals.forEach(d => {
      const stat = stats[person][d];
      const count = stat ? stat.count : 0;
      personTotal += count;
      if (stat) stat.days.forEach(day => personDays.add(day));
      totalPerDiagonal[d] += count;
      tr.innerHTML += `<td>${count || '-'}</td>`;
    });

    grandTotal += personTotal;
    const percent = grandTotal ? ((personTotal / grandTotal) * 100).toFixed(1) : '0.0';
    tr.innerHTML += `<td class="total-col">${personTotal}</td><td>${personDays.size}</td><td>${percent}%</td>`;
    tbody.appendChild(tr);
  });

  table.appendChild(tbody);

  const tfoot = document.createElement('tfoot');
  const footerRow = document.createElement('tr');
  footerRow.innerHTML = '<td>Итого</td>' + diagonals.map(d => `<td class="total-col">${totalPerDiagonal[d]}</td>`).join('') + '<td class="total-col"></td><td></td><td></td>';
  tfoot.appendChild(footerRow);
  table.appendChild(tfoot);

  container.appendChild(table);
}

function populateMonthSelect() {
  const select = document.getElementById('month-select');
  const now = new Date();
  for (let i = 0; i < 12; i++) {
    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    const label = date.toLocaleDateString('pl-PL', { month: 'long', year: 'numeric' });
    select.appendChild(new Option(label.charAt(0).toUpperCase() + label.slice(1), value));
  }
}

let showPercent = false;

async function updateDetailedStats() {
  const selectedMonth = document.getElementById('month-select').value;
  const [year, month] = selectedMonth.split('-').map(Number);
  const combinedData = await fetchData();

  const filtered = combinedData.filter(({ date }) => {
    const dateStr = date?.split(' ')[0];
    if (!dateStr) return false;
    const d = new Date(dateStr);
    return d.getFullYear() === year && (d.getMonth() + 1) === month;
  });

  const stats = calculateDetailedStats(filtered);
  renderTable(stats, showPercent);
}

document.addEventListener('DOMContentLoaded', () => {
  populateMonthSelect();
  document.getElementById('month-select').addEventListener('change', updateDetailedStats);
  document.getElementById('toggle-percent').addEventListener('click', () => {
    showPercent = !showPercent;
    updateDetailedStats();
    document.getElementById('toggle-percent').textContent = showPercent ? 'Показать абсолютные' : 'Показать %';
  });
  updateDetailedStats();
  setInterval(updateDetailedStats, 10000);
});
</script>
</body>
</html>
