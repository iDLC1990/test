<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>LCDR LIVE DATA</title>
  <style>
    body{background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;margin:0}
    .header{display:flex;justify-content:space-between;align-items:center;padding:20px 10%;background:#111}
    .header h1{margin:0;color:#008080;font-size:24px}
    .date-info{color:#008080;font-size:24px}
    .table-container{width:90%;margin:24px auto}
    .table-button{width:100%;padding:12px;background:#008080;color:#000;font-weight:700;
                  font-size:18px;border:0;border-radius:10px 10px 0 0;text-align:left;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-bottom:24px}
    th,td{border:1px solid #fff;padding:10px;text-align:center}
    th{background:#222;color:#0ff}
    .total-row{font-weight:700;background:#333;color:#0ff}
  </style>
</head>
<body>
  <div class="header">
    <h1>LCDR LIVE DATA 2025</h1>
    <div class="date-info" id="date-info">DATE: --</div>
  </div>

  <div class="table-container">
    <button class="table-button">FI Station Overview</button>
    <table id="combined-table">
      <thead>
        <tr>
          <th>NAME</th><th>NDF</th><th>OK</th><th>WAITING</th>
          <th>SCRAP&nbsp;TTL</th><th>SCRAP&nbsp;PNLA</th><th>SUMA&nbsp;CALKOWITA</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button class="table-button">Диагонали по&nbsp;сотрудникам</button>
    <table id="diagonal-table">
      <thead id="diag-head"></thead>
      <tbody id="diag-body"></tbody>
    </table>
  </div>

  <script>
    /* --- Параметры Google Sheets ------------------------------------------ */
    const apiKey   = 'AIzaSyCP7tzYiGwIZ6cymLAlv_9QgPIEshnRgqI';
    const sheetId  = '10W03bvKlVFlIUcxsHkzP_v_13gtnYRBmnrrO0ujB1bU';
    const sheetURL = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/`;

    /* --- Список поддерживаемых диагоналей -------------------------------- */
    const diagonals = [86,85,75,70,65,55,50,49,43,42,34,32,27,24];

    /* --- Вспомогательные функции ----------------------------------------- */
    const extractDiagonal = serial =>
      diagonals.find(d => serial.toUpperCase().includes(String(d))) || null;

    const getData = async sheet =>
      (await fetch(`${sheetURL}${sheet}?key=${apiKey}`)).json();

    /* --- Чтение и пред-обработка всех листов ----------------------------- */
    async function fetchData() {
      const [s1,s2] = await Promise.all([
        getData('FI Station KOVALCHYK Y.'),
        getData('FI Station 2 ULANOVYCH.R')
      ]);
      return [...s1.values.slice(1), ...s2.values.slice(1)];  // пропускаем заголовок
    }

    const getLastDate = rows =>
      new Date(Math.max(...rows.map(r=>new Date((r[0]||'').split(' ')[0]))));

    /* --- Таблица 1: агрегат по статусам ---------------------------------- */
    function calcStatusStats(rows) {
      const out = {};
      rows.forEach(r=>{
        const name=r[5], st=r[4];
        if(!name) return;
        out[name] ??= {NDF:0,OK:0,WAITING:0,'SCRAP TTL':0,'SCRAP PNLA':0,total:0};
        if(st==='NDF')        out[name].NDF++;
        else if(st==='OK')    out[name].OK++;
        else if(st==='WAITING')      out[name].WAITING++;
        else if(st==='SCRAP TTL')    out[name]['SCRAP TTL']++;
        else if(st==='SCRAP PNLA')   out[name]['SCRAP PNLA']++;
        out[name].total++;
      });
      return out;
    }

    function renderStatusTable(stats){
      const tb=document.querySelector('#combined-table tbody');
      tb.innerHTML='';
      const sum={NDF:0,OK:0,WAITING:0,'SCRAP TTL':0,'SCRAP PNLA':0,total:0};
      Object.entries(stats).forEach(([name,s])=>{
        tb.insertAdjacentHTML('beforeend',`
          <tr><td>${name}</td><td>${s.NDF}</td><td>${s.OK}</td><td>${s.WAITING}</td>
              <td>${s['SCRAP TTL']}</td><td>${s['SCRAP PNLA']}</td><td>${s.total}</td></tr>`);
        for(const k in sum) sum[k]+=s[k];
      });
      tb.insertAdjacentHTML('beforeend',`
        <tr class="total-row"><td>SUMA</td><td>${sum.NDF}</td><td>${sum.OK}</td>
            <td>${sum.WAITING}</td><td>${sum['SCRAP TTL']}</td>
            <td>${sum['SCRAP PNLA']}</td><td>${sum.total}</td></tr>`);
    }

    /* --- Таблица 2: Фамилии × Диагонали ---------------------------------- */
    function buildDiagonalTable(rows){
      /* сбор данных */
      const people={}, totals={};
      rows.forEach(r=>{
        const date=(r[0]||'').split(' ')[0];
        const serial=r[2]||'', name=r[5], st=r[4];
        const d=extractDiagonal(serial);
        if(!name||!d||!(st==='OK'||st==='NDF')) return;
        people[name] ??= {};
        people[name][d] ??= {cnt:0,days:new Set()};
        people[name][d].cnt++;  people[name][d].days.add(date);
        totals[d]=(totals[d]||0)+1;
      });

      const usedDiags=Object.keys(totals).map(Number).sort((a,b)=>a-b);
      /* head */
      const head=document.getElementById('diag-head');
      head.innerHTML=`<tr><th>Фамилия</th>${usedDiags.map(d=>`<th>${d}"</th>`).join('')}</tr>`;
      /* body */
      const body=document.getElementById('diag-body'); body.innerHTML='';
      Object.entries(people).forEach(([n,ds])=>{
        const row=`<td>${n}</td>`+
          usedDiags.map(d=>ds[d]?`${ds[d].cnt}/${ds[d].days.size}`:'').join('');
        body.insertAdjacentHTML('beforeend',`<tr>${row}</tr>`);
      });
      /* итоговая строка */
      body.insertAdjacentHTML('beforeend',
        `<tr class="total-row"><td>ИТОГО</td>${usedDiags.map(d=>totals[d]).join('</td><td>')}</td></tr>`);
    }

    /* --- Основной цикл обновления ---------------------------------------- */
    async function update() {
      const rows = await fetchData();
      const last = getLastDate(rows).toISOString().split('T')[0];
      document.getElementById('date-info').textContent=`DATE: ${last}`;

      renderStatusTable(calcStatusStats(rows.filter(r=>r[0]?.startsWith(last))));
      buildDiagonalTable(rows);            // сводная по всем датам
    }

    update(); setInterval(update,6000);
  </script>
</body>
</html>
