<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>LCDR LIVE DATA 2025</title>
<style>
  body {
    background-color: #000;
    color: #fff;
    font-family: Arial, sans-serif;
  }
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 10%;
    background-color: #111;
    flex-wrap: wrap;
  }
  .header h1 {
    margin: 0;
    color: #005050;
    font-size: 24px;
  }
  .controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    flex-wrap: wrap;
  }
  .date-info {
    color: #005050;
    font-size: 18px;
  }
  select {
    padding: 6px 10px;
    font-size: 16px;
    border-radius: 5px;
    border: none;
  }

  #stats-container {
    width: 95%;
    margin: 24px auto;
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background-color: #222;
    color: #fff;
  }
  th, td {
    border: 1px solid #555;
    padding: 0;  /* убираем внутренние отступы для flex блоков */
    text-align: center;
    font-size: 14px;
    white-space: nowrap;
    height: 60px; /* фиксированная высота ячейки */
  }
  th {
    background-color: #005050;
    font-weight: bold;
    position: sticky;
    top: 0;
    z-index: 1;
  }
  td:first-child {
    background-color: #111;
    font-weight: bold;
    text-align: left;
    position: sticky;
    left: 0;
    z-index: 1;
  }
  th.total-col, td.total-col {
    background-color: #005050;
    font-weight: bold;
  }
  tfoot td {
    background-color: #005050;
    font-weight: bold;
  }

  /* --- блоки внутри ячейки --- */
  .cell-status {
    display: flex;
    flex-direction: column;
    height: 100%;
    width: 100%;
  }
  .cell-status span {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #000;
    font-weight: bold;
    font-size: 12px;
  }
  .cell-ok {
    background-color: #ccc;  /* серый */
  }
  .cell-waiting {
    background-color: #ffeb3b; /* жёлтый */
  }
  .cell-scrap {
    background-color: #ff4444; /* красный */
  }
</style>
</head>
<body>
<div class="header">
  <h1>LCDR LIVE DATA 2025</h1>
  <div class="controls">
    <label class="date-info">Tryb:</label>
    <select id="filter-type">
      <option value="day">Dzień</option>
      <option value="month" selected>Miesiąc</option>
      <option value="year">Rok</option>
    </select>

    <label class="date-info">Wybierz:</label>
    <select id="date-select"></select>
  </div>
</div>

<div id="stats-container"></div>

<script>
const apiKey = 'AIzaSyCP7tzYiGwIZ6cymLAlv_9QgPIEshnRgqI';
const sheetId = '10W03bvKlVFlIUcxsHkzP_v_13gtnYRBmnrrO0ujB1bU';
const sheetURL = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/`;

const diagonalMapPrefix = { 'WH8': 55,'WC8': 32,'WU0': 43,'SQ1': 43,'WM5': 50,'WC7': 32,'WP5': 65,'WW1': 75,'WM6': 50 };
const diagonalMap = {
  '860': 86,'850': 85,'750': 75,'700': 70,'650': 65,'580': 58,'575': 58,
  '550': 55,'545': 55,'500': 50,'498': 50,'495': 50,'490': 50,
  '438': 43,'435': 43,'430': 43,'428': 43,'425': 43,'420': 43,
  '418': 43,'415': 43,'398': 43,'395': 43,'390': 43,
  '348': 32,'345': 32,'340': 32,'328': 32,'325': 32,'320': 32,
  '318': 32,'315': 32,
  '278': 27,'275': 27,'270': 27,
  '248': 24,'245': 24,'240': 24,'238': 24,'235': 24,'230': 24
};

const validStatuses = ['OK','NDF'];

function getDiagonals(serial){
  if(!serial || serial.length<6) return [];
  const upper = serial.toUpperCase();
  const result = new Set();
  const match = upper.match(/^[A-Z]{3}(\d{3})/);
  if(match && diagonalMap[match[1]]) result.add(diagonalMap[match[1]]);
  const prefix = upper.slice(0,3);
  if(diagonalMapPrefix[prefix]) result.add(diagonalMapPrefix[prefix]);
  return [...result];
}

async function getData(sheetName){
  try{
    const response = await fetch(`${sheetURL}${encodeURIComponent(sheetName)}?key=${apiKey}`);
    const data = await response.json();
    return data.values || [];
  } catch { return []; }
}

async function fetchData(){
  const sheetNames = ['FI Station KOVALCHYK Y.','FI Station 2 ULANOVYCH.R'];
  let combined = [];
  for(const name of sheetNames){
    const sheetData = await getData(name);
    if(sheetData.length<2) continue;
    const rows = sheetData.slice(1);
    combined = combined.concat(rows.map(row=>({
      date: row[0]||'',
      serial: row[2]||'',
      status: (row[4]||'').toUpperCase(),
      person: row[5]||''
    })));
  }
  return combined;
}

function calculateStats(data){
  const stats = {};
  data.forEach(({person, serial, status})=>{
    const diagonals = getDiagonals(serial);
    if(!diagonals.length) return;
    if(!stats[person]) stats[person]={};
    diagonals.forEach(d=>{
      if(!stats[person][d]) stats[person][d]={ok:0,waiting:0,scrap:0};
      if(status==='OK' || status==='NDF') stats[person][d].ok++;
      else if(status==='WAITING') stats[person][d].waiting++;
      else if(status==='SCRAP TTL' || status==='SCRAP PNLA') stats[person][d].scrap++;
    });
  });
  return stats;
}

function createStatusCell(data){
  const {ok=0,waiting=0,scrap=0} = data||{};
  const cell = document.createElement('td');
  const wrapper = document.createElement('div');
  wrapper.classList.add('cell-status');

  const spanOk = document.createElement('span'); spanOk.classList.add('cell-ok'); spanOk.textContent=ok>0?ok:'';
  const spanWait = document.createElement('span'); spanWait.classList.add('cell-waiting'); spanWait.textContent=waiting>0?waiting:'';
  const spanScrap = document.createElement('span'); spanScrap.classList.add('cell-scrap'); spanScrap.textContent=scrap>0?scrap:'';

  wrapper.appendChild(spanOk); wrapper.appendChild(spanWait); wrapper.appendChild(spanScrap);
  cell.appendChild(wrapper);
  return cell;
}

function renderTable(stats){
  const container = document.getElementById('stats-container');
  container.innerHTML='';
  const diagonals = Array.from(new Set(Object.values(stats).flatMap(p=>Object.keys(p).map(Number)))).sort((a,b)=>b-a);
  const people = Object.keys(stats);
  if(!people.length){ container.innerHTML='<p style="text-align:center; margin-top:20px;">Brak danych</p>'; return; }
  const table = document.createElement('table');
  const thead = document.createElement('thead'); const headerRow = document.createElement('tr');
  const thName = document.createElement('th'); thName.textContent='Name'; headerRow.appendChild(thName);
  diagonals.forEach(d=>{const th=document.createElement('th');th.textContent=d;headerRow.appendChild(th);});
  const thTotal=document.createElement('th'); thTotal.textContent='Total'; thTotal.className='total-col'; headerRow.appendChild(thTotal);
  thead.appendChild(headerRow); table.appendChild(thead);

  const tbody=document.createElement('tbody');
  people.forEach(person=>{
    const tr=document.createElement('tr');
    const tdName=document.createElement('td'); tdName.textContent=person; tr.appendChild(tdName);
    let totalPerson=0;
    diagonals.forEach(d=>{
      const cellData = stats[person][d]||{ok:0,waiting:0,scrap:0};
      totalPerson += cellData.ok + cellData.waiting + cellData.scrap;
      tr.appendChild(createStatusCell(cellData));
    });
    const tdTotal=document.createElement('td'); tdTotal.textContent=totalPerson; tdTotal.className='total-col'; tr.appendChild(tdTotal);
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  container.appendChild(table);
}

function fillDateSelect(filterType){
  const select = document.getElementById('date-select'); select.innerHTML='';
  const now = new Date();
  if(filterType==='day'){ for(let i=0;i<30;i++){ const d=new Date(now.getFullYear(),now.getMonth(),now.getDate()-i); const val=d.toISOString().split('T')[0]; const opt=document.createElement('option'); opt.value=val; opt.textContent=val; select.appendChild(opt); }}
  else if(filterType==='month'){ for(let i=0;i<12;i++){ const d=new Date(now.getFullYear(),now.getMonth()-i,1); const y=d.getFullYear(); const m=(d.getMonth()+1).toString().padStart(2,'0'); const val=`${y}-${m}`; const opt=document.createElement('option'); opt.value=val; opt.textContent=val; select.appendChild(opt); }}
  else if(filterType==='year'){ for(let i=0;i<5;i++){ const y=now.getFullYear()-i; const opt=document.createElement('option'); opt.value=y.toString(); opt.textContent=y.toString(); select.appendChild(opt); }}
  return select.value;
}

async function update(){
  const filterType=document.getElementById('filter-type').value;
  const selectedValue=document.getElementById('date-select').value;
  const allData=await fetchData();
  let filtered=[];
  if(filterType==='day') filtered=allData.filter(d=>d.date.startsWith(selectedValue));
  if(filterType==='month') filtered=allData.filter(d=>d.date.startsWith(selectedValue));
  if(filterType==='year') filtered=allData.filter(d=>d.date.startsWith(selectedValue));
  const stats=calculateStats(filtered);
  renderTable(stats);
}

(async()=>{
  const filterTypeSelect=document.getElementById('filter-type');
  fillDateSelect(filterTypeSelect.value);
  await update();
  filterTypeSelect.addEventListener('change', async()=>{ fillDateSelect(filterTypeSelect.value); await update(); });
  document.getElementById('date-select').addEventListener('change', async()=>{ await update(); });
  setInterval(update,300000);
})();
</script>
</body>
</html>