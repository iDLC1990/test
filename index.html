<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Combined Stats</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
  </style>
</head>
<body>
  <h1>Combined Stats</h1>
  <div>
    <label for="month">Month:</label>
    <select id="month">
      <option value="1">January</option>
      <option value="2">February</option>
      <option value="3">March</option>
      <option value="4">April</option>
      <option value="5">May</option>
      <option value="6">June</option>
      <option value="7">July</option>
      <option value="8">August</option>
      <option value="9">September</option>
      <option value="10">October</option>
      <option value="11">November</option>
      <option value="12">December</option>
    </select>

    <label for="year">Year:</label>
    <input type="number" id="year" value="2024">

    <button id="loadButton">Load Stats</button>
  </div>

  <table id="combinedTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Calls</th>
        <th>SMS</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const spreadsheetId = '1jNzpK3QMu-ywJ_UhVu9rFC0ubqjUpkK1i2_4EVoyESE';
    const apiKey = 'AIzaSyA-rX2G_gvYlDRjeEphqLwYfKQtLhrfSQU';

    async function getData(sheetName) {
      const range = `'${sheetName}'!A1:Z1000`;
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}?key=${apiKey}`;
      const response = await fetch(url);
      const data = await response.json();
      return data.values || [];
    }

    function calculateCombinedStats(data) {
      const stats = {};

      data.forEach(record => {
        const { name, status } = record;
        if (!name || !status) return;

        if (!stats[name]) {
          stats[name] = { calls: 0, sms: 0 };
        }

        if (status.toLowerCase() === 'дзвінок' || status.toLowerCase() === 'дзвінок-вдало') {
          stats[name].calls += 1;
        } else if (status.toLowerCase() === 'смс') {
          stats[name].sms += 1;
        }
      });

      return stats;
    }

    function displayCombinedStats(stats) {
      const tbody = document.querySelector('#combinedTable tbody');
      tbody.innerHTML = '';

      for (const name in stats) {
        const row = document.createElement('tr');
        const nameCell = document.createElement('td');
        const callsCell = document.createElement('td');
        const smsCell = document.createElement('td');

        nameCell.textContent = name;
        callsCell.textContent = stats[name].calls;
        smsCell.textContent = stats[name].sms;

        row.appendChild(nameCell);
        row.appendChild(callsCell);
        row.appendChild(smsCell);
        tbody.appendChild(row);
      }
    }

    document.getElementById('loadButton').addEventListener('click', async () => {
      const month = parseInt(document.getElementById('month').value);
      const year = parseInt(document.getElementById('year').value);

      const sheet1Data = await getData('FI Station KOVALCHYK Y.');
      const sheet2Data = await getData('FI Station 2 ULANOVYCH.R');

      console.log('Sheet1 Header:', sheet1Data[0]);
      console.log('Sheet1 First Row:', sheet1Data[1]);
      console.log('Sheet2 Header:', sheet2Data[0]);
      console.log('Sheet2 First Row:', sheet2Data[1]);

      const combined = [...sheet1Data.slice(1), ...sheet2Data.slice(1)];

      // Предположим: дата = A (0), статус = E (4), имя = F (5)
      const combinedData = combined.map(row => ({
        date: row[0] || '',
        status: row[4] || '',
        name: row[5] || ''
      }));

      const filtered = combinedData.filter(record => {
        if (!record.date || !record.name) return false;
        const dateStr = record.date.split(' ')[0];
        const date = new Date(dateStr);
        return date.getFullYear() === year && date.getMonth() + 1 === month;
      });

      console.log('Filtered Records:', filtered);

      const stats = calculateCombinedStats(filtered);
      console.log('Final Stats:', stats);

      displayCombinedStats(stats);
    });
  </script>
</body>
</html>
