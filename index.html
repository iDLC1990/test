<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>LCDR LIVE DATA</title>
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: Arial, sans-serif;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 10%;
      background-color: #111;
    }

    .table-container {
      width: 90%;
      margin: 24px auto;
    }

    .table-button {
      background-color: #008080;
      color: #000;
      font-weight: bold;
      font-size: 18px;
      padding: 12px;
      border: none;
      border-radius: 10px 10px 0 0;
      width: 100%;
      text-align: left;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 24px;
    }

    th, td {
      border: 1px solid #fff;
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #222;
      color: #0ff;
    }

    .total-row {
      font-weight: bold;
      background-color: #333;
      color: #0ff;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>LCDR LIVE DATA 2025</h1>
    <div class="date-info" id="date-info">DATE: --</div>
  </div>

  <div class="table-container">
    <button class="table-button">FI Station Overview</button>
    <table id="combined-table">
      <thead>
        <tr>
          <th>NAME</th>
          <th>NDF</th>
          <th>OK</th>
          <th>WAITING</th>
          <th>SCRAP TTL</th>
          <th>SCRAP PNLA</th>
          <th>SUMA CALKOWITA</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button class="table-button">Диагонали по сотрудникам</button>
    <table id="diagonal-table">
      <thead id="diag-head"></thead>
      <tbody id="diag-body"></tbody>
    </table>
  </div>

  <script>
    const apiKey = 'YOUR_API_KEY';
    const sheetId = 'YOUR_SHEET_ID';
    const sheetURL = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/`;

    const diagonals = [86, 85, 75, 70, 65, 55, 50, 49, 43, 42, 34, 32, 27, 24];

    function extractDiagonal(serial) {
      const upper = serial.toUpperCase();
      for (let d of diagonals) {
        if (upper.includes(String(d))) return d;
      }
      return null;
    }

    async function getData(sheetName) {
      const response = await fetch(`${sheetURL}${sheetName}?key=${apiKey}`);
      const data = await response.json();
      return data.values;
    }

    async function fetchData() {
      const sheet1 = await getData('FI Station KOVALCHYK Y.');
      const sheet2 = await getData('FI Station 2 ULANOVYCH.R');
      return [...sheet1.slice(1), ...sheet2.slice(1)];
    }

    function getLastDate(data) {
      const dates = data.map(r => r[0]?.split(' ')[0]).filter(Boolean);
      return new Date(Math.max(...dates.map(d => new Date(d))));
    }

    function calculateStats(data) {
      const stats = {};
      data.forEach(row => {
        const name = row[5];
        const status = row[4];
        if (!stats[name]) {
          stats[name] = { NDF: 0, OK: 0, WAITING: 0, 'SCRAP TTL': 0, 'SCRAP PNLA': 0, total: 0 };
        }
        if (status === 'NDF') stats[name].NDF++;
        if (status === 'OK') stats[name].OK++;
        if (status === 'WAITING') stats[name].WAITING++;
        if (status === 'SCRAP TTL') stats[name]['SCRAP TTL']++;
        if (status === 'SCRAP PNLA') stats[name]['SCRAP PNLA']++;
        stats[name].total++;
      });
      return stats;
    }

    function displayCombinedStats(stats) {
      const tbody = document.querySelector('#combined-table tbody');
      tbody.innerHTML = '';
      const total = { NDF: 0, OK: 0, WAITING: 0, 'SCRAP TTL': 0, 'SCRAP PNLA': 0, total: 0 };

      Object.entries(stats).forEach(([name, s]) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${name}</td>
          <td>${s.NDF}</td>
          <td>${s.OK}</td>
          <td>${s.WAITING}</td>
          <td>${s['SCRAP TTL']}</td>
          <td>${s['SCRAP PNLA']}</td>
          <td>${s.total}</td>
        `;
        tbody.appendChild(row);
        Object.keys(total).forEach(k => total[k] += s[k]);
      });

      const tRow = document.createElement('tr');
      tRow.className = 'total-row';
      tRow.innerHTML = `
        <td>SUMA</td>
        <td>${total.NDF}</td>
        <td>${total.OK}</td>
        <td>${total.WAITING}</td>
        <td>${total['SCRAP TTL']}</td>
        <td>${total['SCRAP PNLA']}</td>
        <td>${total.total}</td>
      `;
      tbody.appendChild(tRow);
    }

    function buildDiagonalTable(data) {
      const people = {};
      const allDiags = new Set();

      data.forEach(row => {
        const date = row[0]?.split(' ')[0];
        const serial = row[2] || '';
        const name = row[5];
        const status = row[4];
        const diag = extractDiagonal(serial);
        if (!name || !diag || !(status === 'OK' || status === 'NDF')) return;

        if (!people[name]) people[name] = {};
        if (!people[name][diag]) people[name][diag] = { count: 0, days: new Set() };
        people[name][diag].count++;
        people[name][diag].days.add(date);
        allDiags.add(diag);
      });

      const sortedDiags = Array.from(allDiags).sort((a, b) => a - b);
      const head = document.getElementById('diag-head');
      const body = document.getElementById('diag-body');
      head.innerHTML = `<tr><th>Фамилия</th>${sortedDiags.map(d => `<th>${d}"</th>`).join('')}</tr>`;
      body.innerHTML = '';

      const total = {};

      Object.entries(people).forEach(([name, diagData]) => {
        const row = document.createElement('tr');
        let cells = `<td>${name}</td>`;
        sortedDiags.forEach(d => {
          const cell = diagData[d] ? `${diagData[d].count}/${diagData[d].days.size}` : '';
          if (!total[d]) total[d] = 0;
          total[d] += diagData[d]?.count || 0;
          cells += `<td>${cell}</td>`;
        });
        row.innerHTML = cells;
        body.appendChild(row);
      });

      const totalRow = document.createElement('tr');
      totalRow.className = 'total-row';
      totalRow.innerHTML = `<td>ИТОГО</td>` + sortedDiags.map(d => `<td>${total[d]}</td>`).join('');
      body.appendChild(totalRow);
    }

    async function updateStats() {
      const rawData = await fetchData();
      const lastDate = getLastDate(rawData);
      const dateStr = lastDate.toISOString().split('T')[0];
      document.getElementById('date-info').textContent = `DATE: ${dateStr}`;

      const filtered = rawData.filter(row => row[0]?.startsWith(dateStr));
      const stats = calculateStats(filtered);
      displayCombinedStats(stats);
      buildDiagonalTable(rawData); // <- вся таблица, не только за день
    }

    setInterval(updateStats, 100000);
    updateStats();
  </script>
</body>
</html>
