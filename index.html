<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LCDR LIVE DATA 2025</title>
  <style>
    body { background-color: #000; color: #fff; font-family: Arial, sans-serif; }
    .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 10%; background-color: #111; flex-wrap: wrap; }
    .header h1 { margin: 0; color: #005050; font-size: 24px; }
    .controls { display: flex; align-items: center; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .date-info { color: #005050; font-size: 18px; }
    select, input[type="date"] { padding: 6px 10px; font-size: 16px; border-radius: 5px; border: none; }
    #stats-container, #scrap-waiting-container { width: 90%; margin: 24px auto; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; background-color: #222; color: #fff; }
    th, td { border: 1px solid #555; padding: 8px 10px; text-align: center; font-size: 14px; white-space: nowrap; }
    th { background-color: #005050; font-weight: bold; position: sticky; top: 0; z-index: 1; cursor: pointer; }
    td:first-child { background-color: #111; font-weight: bold; text-align: left; position: sticky; left: 0; z-index: 1; }
    th.total-col, td.total-col { background-color: #005050; font-weight: bold; }
    tfoot td { background-color: #005050; font-weight: bold; }
    .cell-split { display: flex; justify-content: space-between; }
    .scrap { color: #ff5555; }
    .waiting { color: #55ff55; }
    details summary { cursor: pointer; font-size: 18px; color: #005050; margin-bottom: 10px; }
    #range-container { display: none; gap: 10px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>LCDR LIVE DATA 2025</h1>
    <div class="controls">
      <label class="date-info">Tryb:</label>
      <select id="filter-type">
        <option value="day" selected>Dzień</option>
        <option value="week">Tydzień</option>
        <option value="month">Miesiąc</option>
        <option value="year">Rok</option>
        <option value="range">Zakres dat</option>
      </select>
      <label class="date-info">Wybierz:</label>
      <select id="date-select"></select>
      <div id="range-container">
        <input type="date" id="date-from">
        <input type="date" id="date-to">
      </div>
    </div>
  </div>

  <div id="stats-container"></div>

  <details id="scrap-waiting-table">
    <summary>Scrap / Waiting Stats</summary>
    <div id="scrap-waiting-container"></div>
  </details>

  <script>
    // ---- ТВОЙ КОД ЗДЕСЬ (fetchData, getDiagonals и т.д. остаются БЕЗ ИЗМЕНЕНИЙ) ----
    // Я показываю только изменения для диапазона дат

    function fillDateSelect(filterType){
      const select = document.getElementById('date-select'); 
      const rangeContainer = document.getElementById('range-container');
      select.style.display = (filterType === "range") ? "none" : "inline-block";
      rangeContainer.style.display = (filterType === "range") ? "flex" : "none";

      select.innerHTML='';
      const now = new Date();

      if(filterType==='day'){
        for(let i=0;i<30;i++){
          const d = new Date(now.getFullYear(), now.getMonth(), now.getDate()-i);
          const val = d.toISOString().split('T')[0];
          const opt = document.createElement('option'); 
          opt.value=val; opt.textContent=val; 
          if(i===0) opt.selected=true;
          select.appendChild(opt);
        }
      } 
      else if(filterType==='week'){
        for(let i=0;i<12;i++){
          const today = new Date(now);
          const dayOfWeek = today.getDay(); 
          const mondayOffset = (dayOfWeek+6)%7;
          const monday = new Date(today);
          monday.setDate(today.getDate() - mondayOffset - i*7);
          const sunday = new Date(monday);
          sunday.setDate(monday.getDate()+6);
          const startStr = monday.toISOString().split('T')[0];
          const endStr = sunday.toISOString().split('T')[0];
          const val = `${startStr}_${endStr}`;
          const opt=document.createElement('option'); 
          opt.value=val; 
          opt.textContent=`${startStr} → ${endStr}`;
          if(i===0) opt.selected=true;
          select.appendChild(opt);
        }
      }
      else if(filterType==='month'){
        for(let i=0;i<12;i++){
          const d = new Date(now.getFullYear(), now.getMonth()-i,1);
          const y=d.getFullYear(); 
          const m=(d.getMonth()+1).toString().padStart(2,'0');
          const val = `${y}-${m}`;
          const opt=document.createElement('option'); 
          opt.value=val; 
          opt.textContent=val; 
          if(i===0) opt.selected=true;
          select.appendChild(opt);
        }
      }
      else if(filterType==='year'){
        for(let i=0;i<5;i++){
          const y=now.getFullYear()-i;
          const opt=document.createElement('option'); 
          opt.value=y.toString(); 
          opt.textContent=y.toString(); 
          if(i===0) opt.selected=true;
          select.appendChild(opt);
        }
      }
      else if(filterType==='range'){
        const from = document.getElementById("date-from");
        const to = document.getElementById("date-to");
        const today = now.toISOString().split("T")[0];
        from.value = today;
        to.value = today;
      }

      return select.value;
    }

    async function update(){
      const filterType = document.getElementById('filter-type').value;
      const selectedValue = document.getElementById('date-select').value;
      const allData = await fetchData();
      let filtered = [];

      if(filterType==='day'){
        filtered=allData.filter(d=>d.date.startsWith(selectedValue));
      }
      else if(filterType==='week'){
        const [startStr,endStr]=selectedValue.split('_');
        const startDate=new Date(startStr);
        const endDate=new Date(endStr);
        filtered=allData.filter(d=>{
          const cur=new Date(d.date);
          return cur>=startDate && cur<=endDate;
        });
      }
      else if(filterType==='month'){
        filtered=allData.filter(d=>d.date.startsWith(selectedValue));
      }
      else if(filterType==='year'){
        filtered=allData.filter(d=>d.date.startsWith(selectedValue));
      }
      else if(filterType==='range'){
        const from = document.getElementById("date-from").value;
        const to = document.getElementById("date-to").value;
        if(from && to){
          const startDate = new Date(from);
          const endDate = new Date(to);
          filtered = allData.filter(d=>{
            const cur=new Date(d.date);
            return cur>=startDate && cur<=endDate;
          });
        }
      }

      const stats = calculateDetailedStats(filtered);
      renderTable(stats);

      const scrapWaitingStats = calculateScrapWaitingStats(filtered);
      renderScrapWaitingTable(scrapWaitingStats);
    }

    (async()=>{
      const filterTypeSelect=document.getElementById("filter-type");
      fillDateSelect(filterTypeSelect.value);
      await update();
      filterTypeSelect.addEventListener("change", async()=>{
        fillDateSelect(filterTypeSelect.value);
        await update();
      });
      document.getElementById("date-select").addEventListener("change", async()=>{ await update(); });
      document.getElementById("date-from").addEventListener("change", async()=>{ await update(); });
      document.getElementById("date-to").addEventListener("change", async()=>{ await update(); });
      setInterval(update, 300000);
    })();
  </script>
</body>
</html>