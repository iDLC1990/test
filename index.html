<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LCDR LIVE DATA 2026</title>
  <style>
    body {
      background: url("https://raw.githubusercontent.com/iDLC1990/test/main/pexels-iriser-1366957.jpg") no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
    }
    .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 10%; background-color: rgba(0,0,0,0.6); flex-wrap: wrap; border-bottom: 2px solid #00cccc; }
    .header h1 { margin: 0; color: #00cccc; font-size: 24px; text-transform: uppercase; letter-spacing: 2px; }
    .controls { display: flex; align-items: center; gap: 15px; margin-top: 10px; flex-wrap: wrap; }
    .date-info { color: #00cccc; font-size: 16px; font-weight: bold; }
    input[type="date"] { padding: 6px 10px; font-size: 14px; border-radius: 5px; border: 1px solid #00cccc; background: #222; color: #fff; }
    
    #auto-timer { color: #00ffea; font-size: 14px; font-family: monospace; min-width: 180px; background: rgba(0,0,0,0.4); padding: 5px 10px; border-radius: 4px; }

    #stats-container, #scrap-waiting-container { width: 95%; margin: 24px auto; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; background-color: rgba(0,0,0,0.85); color: #fff; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    th, td { border: 1px solid #333; padding: 12px 10px; text-align: center; font-size: 14px; white-space: nowrap; }
    th { background-color: #1a1a1a; color: #00cccc; font-weight: bold; position: sticky; top: 0; z-index: 2; }
    
    .person-row { cursor: pointer; transition: background 0.2s; }
    .person-row:hover { background-color: rgba(0, 204, 204, 0.15); }
    td.name-cell { background-color: #1a1a1a; font-weight: bold; text-align: left; position: sticky; left: 0; z-index: 1; border-right: 2px solid #00cccc; }

    th.total-col, td.total-col { background-color: rgba(0, 204, 204, 0.1); font-weight: bold; border-left: 2px solid #444; }
    
    .detail-row td { background-color: rgba(20, 20, 20, 0.95); padding: 15px; }
    .detail-table { width: 100%; border: 1px solid #444; }
    .detail-table th { font-size: 12px; background: #000; color: #ff69b4; }
    .detail-table td { font-size: 13px; white-space: normal; text-align: left; border-bottom: 1px solid #222; }

    .st-ndf { color: #ff69b4 !important; font-weight: bold; }
    .st-scrap { color: #ff4444 !important; font-weight: bold; }
    .st-waiting { color: #ffff00 !important; font-weight: bold; }
    .st-ok { color: #ffffff; } 

    .cell-split { display: flex; justify-content: space-around; gap: 10px; }
    .scrap { color: #ff4444; font-weight: bold; }
    .waiting { color: #ffff00; font-weight: bold; }
    
    details { width: 95%; margin: 10px auto; background: rgba(0,0,0,0.5); border-radius: 8px; }
    summary { cursor: pointer; font-size: 18px; color: #00cccc; padding: 15px; font-weight: bold; outline: none; }
    summary:hover { color: #fff; }
  </style>
</head>
<body>
  <div class="header">
    <h1>LCDR LIVE DATA 2026</h1>
    <div class="controls">
      <label class="date-info">Od:</label>
      <input type="date" id="date-from"/>
      <label class="date-info">Do:</label>
      <input type="date" id="date-to"/>
      <button id="update-btn" style="padding:8px 16px; border:none; border-radius:5px; background-color:#008080; color:#fff; cursor:pointer; font-weight:bold; transition: 0.3s;">Aktualizuj</button>
      <div id="auto-timer">Auto refresh in: --:--</div>
    </div>
  </div>

  <div id="stats-container"></div>

  <details id="scrap-waiting-table">
    <summary>ðŸ“Š Scrap / Waiting Statistics</summary>
    <div id="scrap-waiting-container"></div>
  </details>

  <script>
    const apiKey = 'AIzaSyCP7tzYiGwIZ6cymLAlv_9QgPIEshnRgqI';
    const sheetId = '10W03bvKlVFlIUcxsHkzP_v_13gtnYRBmnrrO0ujB1bU';
    const sheetURL = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/`;
    const validStatuses = ['OK', 'NDF'];

    let refreshInterval = 300; 
    let countdown = refreshInterval;
    let countdownTimer;
    let lastFilteredData = []; 

    function startCountdown() {
      clearInterval(countdownTimer);
      countdown = refreshInterval;
      
      countdownTimer = setInterval(() => {
        countdown--;
        const mins = Math.floor(countdown / 60);
        const secs = String(countdown % 60).padStart(2, '0');
        document.getElementById('auto-timer').textContent = `Auto refresh in: ${mins}:${secs}`;
        if (countdown <= 0) {
          clearInterval(countdownTimer);
          update(); 
        }
      }, 1000);
    }

    const diagonalMapPrefix = { 'WH8':55,'WC8':32,'WU0':43,'SQ1':43,'WM5':50,'WC7':32,'WP5':65,'WW1':75,'WM6':50 };
    const diagonalMap = {
      '860':86,'850':85,'750':75,'700':70,'650':65,'580':58,'575':58,
      '550':55,'545':55,'500':50,'498':50,'495':50,'490':50,
      '438':43,'435':43,'430':43,'428':43,'425':43,'420':43,
      '418':43,'415':43,'398':43,'395':43,'390':43,
      '348':32,'345':32,'340':32,'328':32,'325':32,'320':32,
      '318':32,'315':32,'278':27,'275':27,'270':27,
      '248':24,'245':24,'240':24,'238':24,'235':24,'230':24
    };

    function getDiagonals(serial){
      if(!serial || serial.length<6) return [];
      const upper = serial.toUpperCase();
      const result = new Set();
      const match = upper.match(/^[A-Z]{3}(\d{3})/);
      if(match && diagonalMap[match[1]]) result.add(diagonalMap[match[1]]);
      const prefix = upper.slice(0,3);
      if(diagonalMapPrefix[prefix]) result.add(diagonalMapPrefix[prefix]);
      return [...result];
    }

    async function getData(sheetName){
      try{
        const response = await fetch(`${sheetURL}${encodeURIComponent(sheetName)}?key=${apiKey}&t=${new Date().getTime()}`);
        const data = await response.json();
        return data.values || [];
      }catch(err){ 
        console.error("Fetch error:", err);
        return []; 
      }
    }

    async function fetchData(){
      const sheetNames = ['FI Station KOVALCHYK Y.','FI Station 2 ULANOVYCH.R'];
      let combined = [];
      for(const name of sheetNames){
        const sheetData = await getData(name);
        if(sheetData.length<2) continue;
        const rows = sheetData.slice(1);
        const mapped = rows.map(row=>({
          date: row[0]||'',
          serial: row[2]||'',
          status: (row[4]||'').toUpperCase(),
          finalna: row[6]||'',
          person: row[5]||'',
          statusH: row[7]||'',
          matrixStatus: row[9]||'',
          description: row[10]||''
        }));
        combined = combined.concat(mapped);
      }
      return combined;
    }

    async function update(){
      const btn = document.getElementById('update-btn');
      const timerLabel = document.getElementById('auto-timer');
      
      btn.style.backgroundColor = "#555";
      btn.textContent = "Updating...";
      timerLabel.textContent = "Fetching new data...";

      const dateFrom = document.getElementById('date-from').value;
      const dateTo = document.getElementById('date-to').value;
      
      if(!dateFrom || !dateTo) { 
        btn.textContent = "Aktualizuj";
        btn.style.backgroundColor = "#008080";
        startCountdown(); 
        return; 
      }

      const allData = await fetchData();
      
      lastFilteredData = allData.filter(d=>{
        const dDate = d.date.split(' ')[0];
        return dDate >= dateFrom && dDate <= dateTo;
      });

      const stats = calculateDetailedStats(lastFilteredData);
      renderTable(stats);

      const scrapWaitingStats = calculateScrapWaitingStats(lastFilteredData);
      renderScrapWaitingTable(scrapWaitingStats);

      btn.style.backgroundColor = "#008080";
      btn.textContent = "Aktualizuj";
      startCountdown();
    }

    // --- ÐžÐ‘ÐÐžÐ’Ð›Ð•ÐÐÐÐ¯ Ð›ÐžÐ“Ð˜ÐšÐ ÐŸÐžÐ”Ð¡Ð§Ð•Ð¢Ð ---
    function calculateDetailedStats(data){
      const stats = {};
      data.forEach(({date, serial, status, person})=>{
        if(!validStatuses.includes(status)) return;
        const diagonals = getDiagonals(serial);
        if(diagonals.length===0) return;

        if(!stats[person]) {
            stats[person] = { 
                diagonals: {}, 
                okCount: 0, 
                ndfCount: 0, 
                days: new Set() 
            };
        }

        const day = date.split(' ')[0];
        if(day) stats[person].days.add(day);

        // Ð¡Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼ OK Ð¸ NDF Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾
        if(status === 'OK') stats[person].okCount++;
        if(status === 'NDF') stats[person].ndfCount++;

        diagonals.forEach(diagonal=>{
          if(!stats[person].diagonals[diagonal]) stats[person].diagonals[diagonal] = { sum:0 };
          stats[person].diagonals[diagonal].sum++;
        });
      });
      return stats;
    }

    function calculateScrapWaitingStats(data){
      const stats = {};
      data.forEach(({serial, status, person})=>{
        if(!person||!serial||!status) return;
        const upperStatus = status.toUpperCase();
        let type = (upperStatus.includes('SCRAP')) ? 'scrap' : (upperStatus.includes('WAITING')) ? 'waiting' : null;
        if(!type) return;
        const diagonals = getDiagonals(serial);
        if(diagonals.length===0) return;
        if(!stats[person]) stats[person]={};
        diagonals.forEach(diagonal=>{
          if(!stats[person][diagonal]) stats[person][diagonal]={scrap:0, waiting:0};
          stats[person][diagonal][type]++;
        });
      });
      return stats;
    }

    // --- ÐžÐ‘ÐÐžÐ’Ð›Ð•ÐÐÐÐ¯ Ð¢ÐÐ‘Ð›Ð˜Ð¦Ð ---
    function renderTable(stats){
      const container=document.getElementById('stats-container'); 
      container.innerHTML='';
      
      const diagonals=Array.from(new Set(Object.values(stats).flatMap(p=>Object.keys(p.diagonals).map(Number)))).sort((a,b)=>b-a);
      
      let people=Object.keys(stats).sort((a,b)=>{
        let sumA = stats[a].okCount + stats[a].ndfCount;
        let sumB = stats[b].okCount + stats[b].ndfCount;
        return sumB - sumA;
      });

      if(people.length===0){ container.innerHTML='<p style="text-align:center; padding: 20px;">Brak danych dla wybranych dat</p>'; return; }

      const table=document.createElement('table');
      // Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¸ OK Ð¸ NDF
      const header = `<thead><tr>
                        <th>Name</th>
                        ${diagonals.map(d=>`<th>${d}</th>`).join('')}
                        <th class="total-col">Total</th>
                        <th class="total-col" style="color:#00ffea">OK</th>
                        <th class="total-col" style="color:#ff69b4">NDF</th>
                        <th class="total-col">Dni</th>
                      </tr></thead>`;
      table.innerHTML = header;

      const tbody = document.createElement('tbody');
      people.forEach(person=>{
        const tr = document.createElement('tr');
        tr.className = 'person-row';
        tr.onclick = () => toggleDetails(tr, person);

        const pData = stats[person];
        const rowTotal = pData.okCount + pData.ndfCount;

        tr.innerHTML = `<td class="name-cell">${person}</td>` + 
                       diagonals.map(d=>`<td>${pData.diagonals[d] ? pData.diagonals[d].sum : '-'}</td>`).join('') +
                       `<td class="total-col">${rowTotal}</td>` +
                       `<td class="total-col" style="color:#00ffea">${pData.okCount}</td>` +
                       `<td class="total-col" style="color:#ff69b4">${pData.ndfCount}</td>` +
                       `<td class="total-col">${pData.days.size}</td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);
    }

    function toggleDetails(row, personName) {
      if(row.nextSibling && row.nextSibling.classList.contains('detail-row')){
        row.nextSibling.remove();
        return;
      }
      const details = lastFilteredData.filter(d => d.person === personName);
      const detailRow = document.createElement('tr');
      detailRow.className = 'detail-row';
      let rowsHtml = details.map(d => {
        let statusClass = "st-ok";
        let rowBg = "transparent";
        const s = d.status.toUpperCase();
        if (s.includes('SCRAP')) { statusClass = "st-scrap"; rowBg = "rgba(255, 0, 0, 0.2)"; } 
        else if (s.includes('WAITING')) { statusClass = "st-waiting"; rowBg = "rgba(255, 255, 0, 0.1)"; } 
        else if (s.includes('NDF')) { statusClass = "st-ndf"; rowBg = "rgba(255, 105, 180, 0.2)"; }
        return `<tr style="background-color: ${rowBg};">
                  <td class="${statusClass}">${d.serial}</td>
                  <td class="${statusClass}">${d.status}</td>
                  <td class="${statusClass}" style="font-weight:bold;">${d.finalna}</td>
                  <td class="${statusClass}">${d.statusH}</td>
                  <td class="${statusClass}">${d.matrixStatus}</td>
                  <td class="${statusClass}">${d.description}</td>
                </tr>`;
      }).join('');
      detailRow.innerHTML = `<td colspan="100%"><table class="detail-table"><thead><tr><th>Serial</th><th>Status</th><th>FINALNA</th><th>H Status</th><th>New / NP</th><th>Info / Description</th></tr></thead><tbody>${rowsHtml}</tbody></table></td>`;
      row.after(detailRow);
    }

    function renderScrapWaitingTable(stats){
      const container = document.getElementById('scrap-waiting-container');
      container.innerHTML = '';
      const diagonals = Array.from(new Set(Object.values(stats).flatMap(p => Object.keys(p).map(Number)))).sort((a,b)=>b-a);
      if(diagonals.length === 0) {
          container.innerHTML = '<p style="text-align:center; padding: 10px;">Brak danych Scrap/Waiting</p>';
          return;
      }
      const table = document.createElement('table');
      table.innerHTML = `<thead><tr><th>Name</th>${diagonals.map(d=>`<th>${d}</th>`).join('')}</tr></thead>`;
      const tbody = document.createElement('tbody');
      Object.keys(stats).forEach(person => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="name-cell">${person}</td>` + 
          diagonals.map(d => {
            if(stats[person][d]) {
              return `<td><div class="cell-split"><span class="scrap">${stats[person][d].scrap}</span><span class="waiting">${stats[person][d].waiting}</span></div></td>`;
            }
            return '<td>-</td>';
          }).join('');
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);
    }

    document.getElementById('update-btn').addEventListener('click', () => {
        clearInterval(countdownTimer);
        update();
    });
    
    const now = new Date();
    const todayStr = now.toISOString().split('T')[0];
    document.getElementById('date-from').value = todayStr;
    document.getElementById('date-to').value = todayStr;
    update();
  </script>
</body>
</html>
